@*
 * Copyright 2020 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import uk.gov.hmrc.gform.sharedmodel.form._
@import uk.gov.hmrc.gform.sharedmodel.formtemplate._
@import uk.gov.hmrc.gform.models._
@import uk.gov.hmrc.gform.validation.{FormFieldValidationResult, ValidationUtil}
@import uk.gov.hmrc.gform.config.FrontendAppConfig
@import uk.gov.hmrc.gform.gform.HasErrors
@import uk.gov.hmrc.gform.views.html.{main_template, specimen}
@import uk.gov.hmrc.govukfrontend.views.viewmodels.backlink.BackLink
@import uk.gov.hmrc.govukfrontend.views.viewmodels.content.Text
@import uk.gov.hmrc.govukfrontend.views.viewmodels.button.Button
@import uk.gov.hmrc.govukfrontend.views.html.components.govukButton
@import uk.gov.hmrc.govukfrontend.views.html.helpers.formWithCSRF
@import uk.gov.hmrc.hmrcfrontend.views.html.components.hmrcPageHeading

@(
  formTemplate: FormTemplate,
  pageLevelError: HasErrors,
  page: SectionRenderingInformation,
  shouldDisplayBack: Boolean,
  shouldDisplayHeading: Boolean,
  shouldDisplayContinue: Boolean,
  frontendAppConfig: FrontendAppConfig,
  isDeclaration: Boolean = false
)(
  implicit
  request: Request[_], //required by CSRF.formField
  messages: Messages,
  l:LangADT,
  viewHelpers: ViewHelpersAlgebra,
  sse: SmartStringEvaluator
)

@heading = @{page.sectionTitle}

@buttonLabel = @{
  if(page.continueLabel.isEmpty) {
    messages("button.saveAndContinue")
  } else {
    page.continueLabel
  }
}

@backLink = @{
  val href =
    if(isDeclaration) {
      uk.gov.hmrc.gform.gform.routes.SummaryController.summaryById(formTemplate._id,page.maybeAccessCode).url
    } else {
      "#"
    }
  new BackLink(attributes=Map("id" -> "backButton"), href = href, content = new Text(messages("linkText.back")))
}

@formWithCSRF = @{new formWithCSRF()}
@govukButton = @{new govukButton()}
@hmrcPageHeading = @{new hmrcPageHeading}

@main_template(
  title = heading,
  serviceName = formTemplate.formName.value,
  containsErrors = pageLevelError.hasErrors,
  developmentPhase = formTemplate.developmentPhase.getOrElse(ResearchBanner),
  frontendAppConfig = frontendAppConfig,
  authConfig = Some(formTemplate.authConfig),
  webChat = formTemplate.webChat,
  formCategory = formTemplate.formCategory,
  languages = formTemplate.languages,
  templateId = formTemplate._id,
  backLink = if(shouldDisplayBack) Some(backLink) else None
) {

    @pageLevelError.render

    @if(shouldDisplayHeading) {
      @hmrcPageHeading(PageHeading(text = heading, section = page.progressIndicator))

      @if(page.sectionDescription.exists(_.trim.nonEmpty)){
        <p class="govuk-body">@{page.sectionDescription.get}</p>
      }
    } else {
      @* This is here to support caption in case of isPageHading case *@
      @page.progressIndicator.fold(HtmlFormat.empty){ caption =>
        <span class="govuk-caption-xl">@caption</span>
      }
    }

    @formWithCSRF(action = page.formAction, args = 'class -> "js-form", 'autocomplete -> "on", 'novalidate -> "novalidate", 'id -> "gf-form") {

      @{page.snippets}

      @{page.hiddenFieldsSnippets}

      <input type="hidden" id="gform-action" name="save" value="Continue" />

      @if(shouldDisplayContinue) {
        @govukButton(Button(content = Text(buttonLabel), value=Some("Continue")))
      }
      @if(page.renderComeBackLater) {
        <p class="govuk-body">
          <a href="#" id="saveComeBackLater" class="govuk-link">@messages("linkText.saveAndComeBackLater")</a>
        </p>
      }
    }

    @if(formTemplate.isSpecimen) {
      @specimen.navigation(formTemplate, page)
    }

    <script type="text/javascript">
      window.gform = window.gform || {};
      window.gform.envelopeId = "@page.envelopeId.value";
      window.gform.formMaxAttachmentSizeMB = "@page.formMaxAttachmentSizeMB";
      window.gform.contentTypes = "@page.contentTypes.map(_.value).mkString(", ")";

      @Html(page.javascripts)
    </script>
}
